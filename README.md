# MS/MS hypothetical structure annotation

[![badge](https://img.shields.io/badge/launch-binder-579ACA.svg?logo=data:image/png;base64,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)](https://mybinder.org/v2/gh/dantheand/msms_structure_annot/2c3342c374ff8129687ca0300d3b27541448a8ec)

## Overview

This package allows you to propose structures for modified peptides with unknown modification patterns using their MS/MS spectra. It also allows you to annotate the MS/MS spectra of modified peptides with these hypothetical structures. The package generates multiple possible hypothetical structures, computationally fragments them, and then aligns those hypothetical fragments to the observed ions in the MS/MS data to give a best estimate as to where the modifications are taking place on the peptide.

This package was primarily coded to support the work presented here:
*\<cite papers when they come out\>*

## Using this project

### Project organization

- `/data`: raw ms/ms data is stored here (never altered)
- `/notebooks`: where analysis notebooks are created and stored; most of the heavy-lifting code is factored out into the source code
- `/reports`: exported reports from analysis notebooks go here
- `/src/msms_structure_annot`: the lightweight package used to contain and organize the custom source code in modules

### Proposed workflow

The proposed workflow is meant to balance reproducibility while still allowing the tinkering required for MS/MS data:

- Put all MS/MS data pertaining to a given experiment into a folder in `/data/<exp_name>`
- Copy a `msms_match_template.ipynb` template notebook from `/notebooks/templates` into `/notebooks` and rename it something useful like `<exp_name>.ipynb`
- Provide parameters for analysis in the new notebook
- Run the notebook and export a report into a folder in `/reports/<exp_name>/reports001/`
- If you want to try different parameters / variations on the same experiment, use the same `<exp_name>.ipynb` notebook, but increment the reports number to output to a different location
  - Take notes on what you're changing in the "Notes" section at the top of the notebook
  - At the end of the notebook, the entire notebook is exported so you preserve the modifications you made in the final report

## Quickstart / Installation

### Binder image

If you just want to take a quick peek at the code, use a Binder instance to interactively explore the example Jupyter notebooks in `/notebooks`. ([binder link](https://mybinder.org/v2/gh/dantheand/msms_structure_annot/2c3342c374ff8129687ca0300d3b27541448a8ec))

### First-time use: install conda environment and package

Download the repository (e.g., on Github use the green "Clone or download" button, then "Download ZIP").

Navigate to the project root directory and run this code in an Anaconda terminal:

```shell
conda env create -f ./environment.yml msms_structure_annot-env
pip install -e ./src
```

This will create the conda environment `msms_structure_annot-env` with all the required dependencies. It also installs the custom package in "editable mode".

### Later uses

After this initial install, you only need to activate the environment before using this package:

```shell
conda activate msms_structure_annot-env
```

### Troubleshooting

If you get the error `Cannot find module: msms_structure_annot`, make sure your Jupyter kernel is using the `msms_structure_annot-env` environment:

```shell
# assuming you have already activated your environment,
python -m ipykernel install --user --name msms_structure_annot-env
```

## More details

### What it's actually doing

- You provide:
  - Input of one or more ms/ms files
  - Linear peptide sequence
  - Knowledge of potential modification types / locations
- It does:
  - MS/MS spectra s/n filtering
  - Generates a series of hypothetical modified peptide structures
  - Generates fragmentation profiles for those hypothetical structures
  - Maps observed MS/MS peaks onto each hypothetical structure
  - Provides metrics to score which hypothetical structure is most likely
- It outputs:
  - Plots of ms/ms spectra with masses from hypothetical structure fragment masses mapped onto it
  - Tables of matched masses
  - Tables of hypothetical structures and their scores
  - The Jupyter notebook used to make a given report

### Inputs

- All currently provided in the notebook

#### File names and locations

- data files location
- export location

#### MS/MS data

- One or more MS/MS spectra as tab-separated or comma separated file for a compound:
  - Column 1: m/z
  - Column 2: Abundance
- When using multiple spectra (e.g. when trying multiple fragmentation strengths),
  - Name files as `ms[0-9].csv` and put them into the same folder in `/data/<experiment-name>`

#### Modification information

- For modification type:
  - mass shift
  - potential modified residue locations
  - total number of modifications (you should know this from the total mass shift of the selected ion)

```python
# Original AA sequence
parent_seq = 'GCMSKELEKVLESSSMAKGDGWKVMAKGDGWE' # Will be referred to as one-indexed from here on

# Define N and C-term modifications and their mass shifts
N_term_mod = 1.0078
C_term_mod = 17.0027
proton_m = 1.0078
# Define number of charges to calculate m/z values for
charges = [1,2,3]

ptm_dict = {
    'name': [
        'rSAM thioether',  # Name of the modification type
    ],
    'm_shift': [  # Mass shift for a given modification
        -1.007, 
    ], 
    'num_mods': [ # Total number of modifications observed
        2, 
    ], 
    'poss_mod_pos': [ # Potential modification positions (one-indexed)
        [18,22,15,5],
    ],
    'type': [  # Type of modification (ring or point); (ring feature not currently implemented)
        'point',
    ]
}
```

#### Spectra processing parameters

```python
tol = 0.05 # mass-deviation tolerance; Default 0.4
sn_thr = 0.1 # signal-to-noise threshold (must be sn_thr times above background for ion to count); Default 5
N = 12800 # Number of sections to split m/z datapoints into when calculating background values; Default 500
upper_lim = 10 # limit to deviance above average ms ion intensity to set ion values to a limit; Default 50
```

### Outputs

#### Ranked hypothetical structures

Based on various metrics, the likelihood of the peptide being a specific structure is scored. Higher scores are more likely structures

![Hypothetical structure ranking example.](/docs/images/hs_rank_example.png)

#### Annotated MS/MS spectra

After choosing one hypothetical structure, you can map the hypothetical ions (blue) onto the observed ions for spectra.

![MS/MS annotation.](/docs/images/msms_matched_example.png)



## Future features that would be helpful

- Expand the fragmentation code to work for ring structures.

## Acknowledgements

This work heavily leans on the methods proposed and developed by the van der Donk group here: [10.1073/pnas.1406418111](https://doi.org/10.1073/pnas.1406418111)
